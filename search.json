[{"title":"固定效应模型","url":"/2025/07/06/My-First-Post/","content":"我想，只具备初级计量经济学知识的你在看期刊论文时一定非常迷茫，说好的咱都是用计量经济做实证呢，我学的计量和他用的计量怎么不像是一个计量呢？我只知道外生性、均值独立、异方差什么的，怎么一下子这些概念全部都不见了，取而代之的是什么平行趋势假设、混淆变量？\r\n非常正常，因为现在论文里面已经很少用传统的计量经济学了，更多的是因果推断方法。把传统计量经济学和新兴的因果推断联系到一起，你就踏入了写期刊论文的门槛。\r\n双重固定效应模型 (FE) 是很典型的计量经济方法，而\r\nDID (双重差分) 则是很典型的因果推断方法。\r\n我在这里想说的是，其实 DID\r\n因果推断和计量经济学双重固定效应模型本质上是一样的，不过我们从不同的角度出发去解释罢了（或许还有些细节上处理的不同，后面会一一介绍）。\r\n接下来我就把期刊论文中最常用的几种模型一一介绍给你。\r\n\r\n从固定效应模型开始\r\n经典的双重固定效应模型如下：\r\nYit=τDit+βXit+αi+ξt+ϵit\r\n Y_{it}=\\tau D_{it} +\\beta X_{it} + \\alpha _i + \\xi_{t} + \\epsilon_{it}\r\n\r\n这个模型建立在经典计量经济学的假设上，也就是说你只需要在你已经熟悉的OLS上多走一步就可以了！（你熟知的iid，同方差，外生性等名词都会在这里见到并讨论。）\r\n一个非常简单的理解，经典OLS对于面板数据束手无策，因为它不考虑时间不变和个体异质性。那么固定效应模型就是加入了αi\\alpha _i和ξt\\xi_t去捕捉个体和时间的异质性。\r\n\r\n注意这个地方，αi\\alpha _i和ξt\\xi_t不是随机变量，它们是控制项（不是我们直接关心的参数，可以理解为常数，但这个“常数”是对每个个体i或每个时间点t而言的），在stata命令中会被自动控制掉（demean掉）。\r\n\r\n下面几个假设看看就可以了，和经典OLS可谓是一摸一样。\r\n\r\n误差项独立同分布 (IID)\r\n\r\n每个时间点的误差项\r\nϵit\\epsilon_{it}\r\n独立于其他时间点的误差项。\r\n每个个体的误差项\r\nϵit\\epsilon_{it}\r\n独立于其他个体的误差项。\r\n\r\n解释变量\r\nXitX_{it}\r\n与误差项同方差\r\n\r\n每个解释变量\r\nXitX_{it}\r\n与误差项\r\nϵit\\epsilon_{it}\r\n同方差。\r\n\r\n解释变量\r\nXitX_{it}\r\n与处理变量\r\nDitD_{it}\r\n线性相关\r\n\r\n解释变量\r\nXitX_{it}\r\n与处理变量\r\nDitD_{it}\r\n存在线性相关。\r\n\r\n\r\nQ1：什么时候用固定效应模型？（一些重要的假设检验）\r\n\r\n随机效应模型 vs. 固定效应模型\r\n\r\n如果个体特性（比如地区发展水平）会影响解释变量\r\nXitX_{it}，就不能用随机效应，要用固定效应。\r\n如何判断？ 做个 Hausman\r\n检验，看看两种估计值是否有系统性差异。\r\n注意： 在异方差的情况下 Hausman\r\n检验不管用，需要使用 Bootstrap 或者辅助回归。\r\n\r\n强外生性假设\r\n(ϵit⟂Djs,Xj,αj\\epsilon_{it}\\perp D_{js},X_j,\\alpha _j)\r\n\r\n理解1：\r\n自己的误差项与自己和他人的处理变量都独立。这意味着处理状态的分配与潜在结果无关。\r\n\r\n自己的误差项与自己的处理变量独立（你的结果不应该反过来影响你的处理状态，否则就存在“反向因果”和“内生性”）\r\n自己的误差项与别人的处理变量独立（没有跨单位溢出效应，SUTVA的一部分）\r\n\r\n理解2：\r\nYit⟂Di∣Xi,αi,ξtandYjt⟂Di∣Xj,αj,ξtY_{it} \\perp D_i \\mid X_i, \\alpha_i, \\xi_t \\quad \\text{and} \\quad Y_{jt} \\perp D_i \\mid X_j, \\alpha_j, \\xi_t\r\n&gt;\r\n控制了个体固定效应、时间效应、协变量之后，处理变量和结果变量之间没有剩余相关性。\r\n与平行趋势的关系：\r\n强外生性假设可以推导出平行趋势假设。\r\nE[Yit(0)−Yi,t−1(0)∣Dit=1]=E[Yit(0)−Yi,t−1(0)∣Dit=0]E[Y_{it}(0) - Y_{i,t-1}(0) \\mid D_{it} = 1] = E[Y_{it}(0) - Y_{i,t-1}(0) \\mid D_{it} = 0]\r\n&gt; 你看！这就联系起来了 双重固定效应模型 和\r\n双重差分因果推断模型！\r\n如何检验？\r\n并没有完美的检验方法。常用的是事件研究法（Event\r\nStudy）来做动态效应分析，但这通常只适用于二元处理变量。\r\n\r\n注意标准误 (Standard Error)\r\n\r\n问题：\r\n当数据存在序列相关时（例如，同一个省份多年的数据高度相关），传统的标准误会被低估。\r\n解决方法： 使用聚类标准误 (Clustered\r\nStandard\r\nErrors)。通常在政策分配的层级进行聚类（如政策在市级分配，就在市级聚类）。\r\n例子： 你有 50 个省，每个省 10\r\n年数据。如果不聚类，Stata 会认为这是 500\r\n个独立观测。但实际上，每个省份内部的观测是高度相关的。正确的做法是按 50\r\n个省来聚类，从而得到更准确的标准误。\r\n\r\n\r\n\r\n\r\nQ2：如何应用固定效应模型？\r\n第一步：描述性统计\r\n首先，通过图表展示数据的基本特征。下面是生成描述性统计表格的 Stata\r\n代码示例。\r\n********************************* Table 1: Descriptive Statistics********************************use &quot;data/xy2015.dta&quot;, clear* 检查数据平衡性tab yearunique vill_id* 事件研究图panelview inv vcfirst2, i(vill_id) t(year) type(treat) bytiming* 变量描述性统计tabstat inv loginv log_levies logpopl logincome logasset hhsize landpc logmigration logtax logtransfer share_admin postcont postopen secret_ballot proxy_voting moving_ballot, s(N mean sd min max) c(s)* 仅保留选举年份数据keep if elecyr==1tabstat vcfirst vcsecond vcfirst2 vc_char_* vote psfirst2 vcps_clan vcps_person vc_pb, s(N mean sd min max) c(s)* 查看特定年份数据use &quot;data/xy2015.dta&quot;, clearkeep if year==2005tabstat clan_num clansz* largeclan family_tree ances_hall, s(N mean sd min max) c(s)\r\n第二步：基准回归\r\n逐步引入变量，进行回归分析。\r\n********************************* Table 2: Baseline Results********************************use &quot;data/xy2015.dta&quot;, clear* 仅包含年份固定效应reghdfe loginv vcfirst vcsecond, a(year) cl(vill_id)* 双重固定效应 (个体 + 年份)reghdfe loginv vcfirst vcsecond, a(vill_id year) cl(vill_id)* 使用 Bootstrap 获取稳健标准误bootstrap _b, rep(200) cl(vill_id): reghdfe loginv vcfirst vcsecond, a(vill_id year)* 加入省级线性时间趋势reghdfe loginv vcfirst vcsecond, a(vill_id year i.prov_id#c.year) cl(vill_id)* 加入村级线性时间趋势* reghdfe loginv vcfirst vcsecond, a(vill_id year c.year#i.vill_id) cl(vill_id)* 加入控制变量组1reghdfe loginv vcfirst vcsecond hhsize landpc logpopl logincome logasset, a(vill_id year i.prov_id#c.year) cl(vill_id)* 加入控制变量组2reghdfe loginv vcfirst vcsecond hhsize landpc logpopl logincome logasset logmigration logtax logtransfer, a(vill_id year i.prov_id#c.year) cl(vill_id)\r\n第三步：事件研究与动态效应\r\n通过事件研究图来检验平行趋势假设，并观察政策的动态效应。\r\n************************************ Figure 3: Dynamic Effect Plot***********************************use &quot;data/xy2015.dta&quot;, clear* 回归获取各期系数reghdfe loginv vc_in_office*, a(vill_id year) cl(vill_id)* 提取系数和标准误用于绘图gen coef = . gen se = . local j = 2 foreach var of var vc_in_office* &#123;    replace coef = _b[`var&#x27;] in `j&#x27;    replace se = _se[`var&#x27;] in `j&#x27;    local ++j&#125;* 计算 95% 置信区间gen up_ci = coef + 1.96 * segen low_ci = coef - 1.96 * segen Year = _n - 7keep in 1/13* 绘制动态效应图tw (scatter coef Year, msymbol(o) mcolor(navy)) ///   (rcap up_ci low_ci Year, lp(dash) lcolor(maroon)), ///   yline(0, lpattern(dash)) ///   xlabel(-5 &quot;-5&quot; -4 &quot;-4&quot; -3 &quot;-3&quot; -2 &quot;-2&quot; -1 &quot;-1&quot; 0 &quot;0&quot; 1 &quot;1&quot; 2 &quot;2&quot; 3 &quot;3&quot; 4 &quot;4&quot; 5 &quot;&gt;4&quot;) ///   legend(off) title(&quot;Dynamic Treatment Effect&quot;)   * 导出图像gr export &quot;Figure3.pdf&quot;, replace\r\n\r\nQ3：如何从因果推断角度理解强外生性假设？\r\n在因果推断中我们并不强调强外生性假设，更注重的是平行趋势假设（你可以认为我们在因果推断中放宽了假定条件）。因果推断方法更像实验方法而非数学方法，注重的是因果关系（文字描述和实验设计），而不是严格的计量经济学假设（数理推导），所以在阐释DID时我们会用更多文字、图表而非公式来帮助大家理解。\r\n\r\n平行趋势假设：在没有处理的情况下（即 counterfactual\r\nworld），处理组和控制组的变化趋势应该是一样的。\r\n那么如何直观理解强外生性假设可以推导出平行趋势假设呢？\r\n\r\n强外生性确保了处理不是“因为误差”才发生的 ⇒ 没有系统性偏差 ⇒\r\n潜在结果的变化趋势（未处理时）是一样的 ⇒ 即平行趋势。\r\n举一个例子，假设你要研究一个教育补贴政策的效果。如果政府是随机决定哪些学生在某年获得补贴（不是因为预测他们将变好或变差），那么你就可以相信：如果没人得到补贴，他们的学习成绩提升趋势是一样的。\r\n\r\n\r\n\r\nQ4：关于非平衡面板\r\n(Unbalanced Panel)\r\n\r\n注意：\r\n如果样本中的某些个体在后续追踪中丢失，需要警惕样本选择偏误。如果丢失的原因与研究结果相关（即内生的），则估计结果会有偏，此时需要使用“样本选择模型”（如\r\nHeckman 模型）进行修正。\r\n\r\n"},{"title":"LaTeX数学公式示例","url":"/2025/01/10/latex-math-example/","content":"这篇文章演示了如何在Hexo博客中使用LaTeX数学公式。\r\n行内公式\r\n这是一个简单的行内公式：E=mc2E = mc^2，爱因斯坦的质能方程。\r\n另一个例子：当\r\na≠0a \\ne 0\r\n时，一元二次方程\r\nax2+bx+c=0ax^2 + bx + c = 0\r\n的解为\r\nx=−b±b2−4ac2ax = \\frac{-b \\pm \\sqrt{b^2-4ac}}{2a}。\r\n块级公式\r\n积分公式\r\n∫abf(x)dx=F(b)−F(a)\\int_{a}^{b} f(x)dx = F(b) - F(a)\r\n求和公式\r\n∑i=1ni=n(n+1)2\\sum_{i=1}^{n} i = \\frac{n(n+1)}{2}\r\n矩阵\r\n(abcd)(xy)=(ax+bycx+dy)\\begin{pmatrix}\r\na &amp; b \\\\\r\nc &amp; d\r\n\\end{pmatrix}\r\n\\begin{pmatrix}\r\nx \\\\\r\ny\r\n\\end{pmatrix}\r\n=\r\n\\begin{pmatrix}\r\nax + by \\\\\r\ncx + dy\r\n\\end{pmatrix}\r\n分数和根号\r\nddx(∫0xf(u)du)=f(x)\\frac{d}{dx}\\left( \\int_{0}^{x} f(u)\\,du\\right)=f(x)\r\nx2+y2=r\\sqrt{x^2 + y^2} = r\r\n希腊字母\r\nα+β=γ\\alpha + \\beta = \\gamma\r\n∑i=1∞1i2=π26\\sum_{i=1}^{\\infty} \\frac{1}{i^2} = \\frac{\\pi^2}{6}\r\n常用LaTeX语法\r\n\r\n上标：x^2 →\r\nx2x^2\r\n下标：x_1 →\r\nx1x_1\r\n分数：\\frac&#123;a&#125;&#123;b&#125; →\r\nab\\frac{a}{b}\r\n根号：\\sqrt&#123;x&#125; →\r\nx\\sqrt{x}\r\n求和：\\sum_&#123;i=1&#125;^&#123;n&#125; →\r\n∑i=1n\\sum_{i=1}^{n}\r\n积分：\\int_&#123;a&#125;^&#123;b&#125; →\r\n∫ab\\int_{a}^{b}\r\n希腊字母：\\alpha, \\beta, \\gamma →\r\nα,β,γ\\alpha, \\beta, \\gamma\r\n\r\n现在你可以在Hexo博客中自由使用LaTeX数学公式了！\r\n","tags":["数学","LaTeX"]},{"title":"Hello World","url":"/2025/07/06/hello-world/","content":"Welcome to Hexo! This is your very\r\nfirst post. Check documentation for\r\nmore info. If you get any problems when using Hexo, you can find the\r\nanswer in troubleshooting or\r\nyou can ask me on GitHub.\r\nQuick Start\r\nCreate a new post\r\n$ hexo new &quot;My New Post&quot;\r\nMore info: Writing\r\nRun server\r\n$ hexo server\r\nMore info: Server\r\nGenerate static files\r\n$ hexo generate\r\nMore info: Generating\r\nDeploy to remote sites\r\n$ hexo deploy\r\nMore info: Deployment\r\n"},{"title":"经典双重差分法（2X2双重差分法）","url":"/2025/07/14/%E5%8F%8C%E9%87%8D%E5%B7%AE%E5%88%86%E6%B3%95/","content":"接下来我们就将正式进入双重差分法的研究，这是一个注重因果推断的方法，在这里你可以忘掉所有的经典计量经济学假设，并且见识好多不熟悉的名词，没有关系，我们将一一解释。\r\nQ1：为什么会有双重差分法（理论前提）？\r\n这一部分可能有一点枯燥难懂，但我们尽量用通俗的语言去解释它。\r\n潜在结果框架：\r\n\r\n\r\n\r\n对于个体i，Yi(1)Y_i(1)和Yi(0)Y_i(0)代表接受这种处理或没有接受这种处理的潜在结果。我们可以观测到的有Yi,t=2(1)Y_{i,t=2}(1)、Yi,t=1(1)Y_{i,t=1}(1)、Yi,t=2(0)Y_{i,t=2}(0)、Yi,t=1(0)Y_{i,t=1}(0)\r\n而我们需要的是ATT（处理效应），即求：\r\n因果效应=Yit(1)−Yit(0)\r\n\\boxed{\\text{因果效应} = Y_{it}(1) - Y_{it}(0)}\r\n &gt;\r\n牢记这个公式！你会发现后面我们的公式越来越复杂，又有期望又有条件，但是本质都是这个公式，不过多加了一些限定，使得它从数理上来讲更严谨！\r\n问题在于我们无法在同一时间同一个体上既观测到$\r\nY_{it}(1)又观测到又观测到Y_{it}(0)$。\r\n&lt;div style=\"float:right; margin-left:15px; width:200px;\"&gt;\r\n\r\n&lt;/div&gt;\r\n由于数据缺失问题，因果推断变得不那么容易，在时间t时我们如何得到$Y_{i,t}(1),Y_{i,t}(0)呢？若我们认为所有个体和所有时间的情况均相同（即不存在异质性），那么我们可以直接求出个体ATT，但在现实生活中，这个假设往往不成立，因此我们关注处理的平均效应，且只关注处理处理后的效果即：呢？若我们认为所有个体和所有时间的情况均相同（即不存在异质性），那么我们可以直接求出个体ATT，但在现实生活中，这个假设往往不成立，因此我们关注处理的平均效应，且只关注处理处理后的效果即：ATT=𝔼[Yi,t=2(1)|Di=1]−𝔼[Yi,t=2(0)|Di=1]ATT = \\mathbb E[Y_{i,t=2}(1)|D_i=1] - \\mathbb E[Y_{i,t=2}(0)|D_i=1]$\r\n&gt; Q:为什么我们只关注处理后的效应？ &gt; A: - 因为t=1时处理还没有发生\r\n-\r\n我们无法得到处理组（t=2）的Yit(0)Y_{it}(0)所以我们用控制组的Yit(0)Y_{it}(0)来替代（这就需要平行趋势假设）\r\n-\r\nDID的本质是构造（counterfactual），我们只能估计处理组在处理后“如果没处理”的样子。\r\n辨析：YitY_{it}\r\n和Yit(0)Y_{it}(0)到底是什么关系？\r\n- $Y_&#123;it&#125;$ 是我们在数据中能看到的**实际观测值**：\r\n- \r\nYit(0) 是单位 i 在时间 t 未接受处理（control）下的潜在结果（counterfactual outcome）\r\n\\boxed{Y_{it}(0) \\text{ 是单位 } i \\text{ 在时间 } t \\text{ 未接受处理（control）下的潜在结果（counterfactual outcome）}}\r\n\r\n\r\n它 不是实际观测值（除非\r\nDit=0D_{it} = 0）；\r\n而是理论上，如果单位\r\nii\r\n在\r\ntt\r\n时刻没有接受处理，会呈现的那一个结果；\r\n属于潜在结果模型（potential outcomes\r\nframework）中的一个关键变量。\r\n\r\n\r\n\r\n因果推断的两种潜在结果\r\n\r\n在因果推断中（包括\r\nDiD、合成控制、潜因子模型等方法），每个个体在每个时间点都对应两个潜在结果：\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n状态\r\n表示\r\n含义\r\n\r\n\r\n\r\n\r\n未处理时的结果\r\nYit(0)Y_{it}(0)\r\n单位\r\nii\r\n在时间\r\ntt，如果没接受政策，会是什么样\r\n\r\n\r\n已处理时的结果\r\nYit(1)Y_{it}(1)\r\n单位\r\nii\r\n在时间\r\ntt，如果接受了政策，会是什么样\r\n\r\n\r\n\r\n而你能看到的实际观测值是：\r\nYit=Dit⋅Yit(1)+(1−Dit)⋅Yit(0)\r\nY_{it} = D_{it} \\cdot Y_{it}(1) + (1 - D_{it}) \\cdot Y_{it}(0)\r\n ### 总结\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n术语\r\n含义\r\n\r\n\r\n\r\n\r\nYit(0)Y_{it}(0)\r\n单位\r\nii\r\n在时间\r\ntt\r\n未处理状态下的结果（反事实）\r\n\r\n\r\n是否观测？\r\n只有当\r\nDit=0D_{it} = 0\r\n时我们能观察到\r\n\r\n\r\n在图中作用\r\n建模/拟合/估计“没有政策干预时”的情况，进而估计处理效应\r\n\r\n\r\n相关方法\r\n合成控制、因子模型、SDID、IFE、Matrix Completion\r\n\r\n\r\n\r\n\r\nQ2：要满足什么假设？\r\n\r\n平行趋势假设：在没有处理的情况下（即 counterfactual\r\nworld），处理组和控制组的变化趋势应该是一样的。\r\n\r\n可以排除时变混淆变量、反向因果和内生性问题\r\n检验是否自选择\r\n\r\nSUTVA假设：无溢出效应，处理值是唯一的（你说“学生A参加了补习班”，那所有参加补习班的学生内容应该类似；如果有的学生补英语，有的补数学，那“处理”就不是唯一的）。\r\n无预期效应假设：处理前没有“因果效应”（在政策真正生效前，被处理单位不会因为“预期到将来会处理”而提前改变行为。）\r\n#### Q3：双重差分的推导\r\nATT=𝔼[Yi,t=2(1)|Di=1]−𝔼[Yi,t=2(0)|Di=1]ATT = \\mathbb E[Y_{i,t=2}(1)|D_i=1] - \\mathbb E[Y_{i,t=2}(0)|D_i=1]\r\nATT=𝔼[Yi,t=2|Di=1]−𝔼[Yi,t=2(0)|Di=1]ATT = \\mathbb E[Y_{i,t=2}|D_i=1] - \\mathbb E[Y_{i,t=2}(0)|D_i=1]\r\n其中𝔼[Yi,t=2|Di=1]\\mathbb E[Y_{i,t=2}|D_i=1]可从数据中估计（根据SUTVA），后面的仍取决于潜在结果。\r\n平行趋势假设：在没有处理的情况下，处理组和控制组结果变量随时间的平均发展趋势相同：\r\n𝔼[Yi,t=2(0)|Di=1]−𝔼[Yi,t=1(0)|Di=1]=E[Yi,t=2(0)|Di=0]−𝔼[Yi,t=1(0)|Di=0]\\mathbb E[Y_{i,t=2}(0)|D_i=1] - \\mathbb E[Y_{i,t=1}(0)|D_i=1] = E[Y_{i,t=2}(0)|D_i=0] - \\mathbb E[Y_{i,t=1}(0)|D_i=0]\r\n下面带入平行趋势假设求𝔼[Yi,t=2(0)|Di=1]\\mathbb E[Y_{i,t=2}(0)|D_i=1]：\r\n𝔼[Yi,t=2(0)|Di=1]=𝔼[Yi,t=1(0)|Di=1]+𝔼[Yi,t=2(0)|Di=0]−𝔼[Yi,t=1(0)|Di=0]\\mathbb E[Y_{i,t=2}(0)|D_i=1] = \\mathbb E[Y_{i,t=1}(0)|D_i=1] + \\mathbb E[Y_{i,t=2}(0)|D_i=0] - \\mathbb E[Y_{i,t=1}(0)|D_i=0]\r\n根据无预期假设：\r\n𝔼[Yi,t=2(0)|Di=1]=𝔼[Yi,t=1(1)|Di=1]+𝔼[Yi,t=2(0)|Di=0]−𝔼[Yi,t=1(0)|Di=0]\\mathbb E[Y_{i,t=2}(0)|D_i=1] = \\mathbb E[Y_{i,t=1}(1)|D_i=1] + \\mathbb E[Y_{i,t=2}(0)|D_i=0] - \\mathbb E[Y_{i,t=1}(0)|D_i=0]\r\n根据SUTVA：\r\n𝔼[Yi,t=2(0)|Di=1]=𝔼[Yi,t=1|Di=1]+𝔼[Yi,t=2|Di=0]−𝔼[Yi,t=1|Di=0]\\mathbb E[Y_{i,t=2}(0)|D_i=1] = \\mathbb E[Y_{i,t=1}|D_i=1] + \\mathbb E[Y_{i,t=2}|D_i=0] - \\mathbb E[Y_{i,t=1}|D_i=0]\r\n则ATT为：\r\nATT=(𝔼[Yi,t=2|Di=1]−𝔼[Yi,t=1|Di=1])−(𝔼[Yi,t=2|Di=0]−𝔼[Yi,t=1|Di=0])ATT = (\\mathbb E[Y_{i,t=2}|D_i=1] - \\mathbb E[Y_{i,t=1}|D_i=1]) - (\\mathbb E[Y_{i,t=2}|D_i=0] - \\mathbb E[Y_{i,t=1}|D_i=0])\r\n&gt; 从这个式子中我们可以很好地看出双重差分法的两次差分在哪里。\r\n\r\nQ4：用什么办法估计ATT？\r\n\r\n简单粗暴法\r\n双向固定效应（TWFE）\r\n\r\nQ5：如何处理干预前协变量？\r\n- 干预前协变量是什么？\r\n- 处理方法：对未处理组进行加权，使他们在干预前协变量上更像处理组\r\n\r\n处理组协变量均值为\r\nX‾T\\bar{X}_T\r\n控制组协变量矩阵为\r\nXCX_C\r\n\r\n你想找一组控制组的权重\r\nwiw_i，使得：\r\n∑i∈controlwiXi=X‾T\r\n\\sum_{i \\in \\text{control}} w_i X_i = \\bar{X}_T\r\n\r\n"},{"title":"双固定效应模型的问题","url":"/2025/07/15/%E5%8F%8C%E5%9B%BA%E5%AE%9A%E6%95%88%E5%BA%94%E6%A8%A1%E5%9E%8B%E7%9A%84%E9%97%AE%E9%A2%98/","content":"在了解完经典DID（2x2DID）和双固定效应模型后，我们就可以进一步来探索更加前沿、更加复杂的因果推断模型了。\r\n首先我们要知道，为什么会出现更前沿、更复杂的因果推断模型。难道双固定模型和经典DID不好吗？\r\n经典DID很明显不好，因为它只能处理一个冲击的情况。如果我的政策实施是分批实现的呢？比如政策在2010年先在厦门实施，2015年在重庆实施，2020年在深圳实施，政策在不同的时间点实施，这时候用2x2DID就不适用了。\r\n&gt; 这在中国尤其普遍，从政策试点城市到全国普遍推行。\r\n那么双固定效应模型有什么缺点呢？为何还要研究更前沿的因果推断方法呢？我们在这一个part做出介绍。\r\nQ1：强外生性假设究竟意味着什么？\r\nImai &amp; Kim(2019) - 没有随时间变化的混淆变量 &gt; 混淆变量是什么？\r\n- 没有反馈效应 - 没有延续效应 - 没有预期效应（徐轶青老师提出）\r\n\r\n也就是经典双重差分的假设： - 平行趋势假设：在没有处理的情况下（即\r\ncounterfactual world），处理组和控制组的变化趋势应该是一样的。 -\r\n可以排除时变混淆变量、反向因果和内生性问题 - 检验是否自选择 -\r\nSUTVA假设：无溢出效应，处理值是唯一的（你说“学生A参加了补习班”，那所有参加补习班的学生内容应该类似；如果有的学生补英语，有的补数学，那“处理”就不是唯一的）。\r\n-\r\n无预期效应假设：处理前没有“因果效应”（在政策真正生效前，被处理单位不会因为“预期到将来会处理”而提前趋势\r\n\r\nQ2：在有处理效应异质性的情况下，双重固定效应估计量是否是到个体处理效应的凸组合（加权平均）？\r\n我们在讨论ATT时，希望得到的是个体处理效应的平均效应，而在有处理效应异质性的情况下双固定效应得到的估计量是个体处理效应的平均效应吗？\r\n&gt;\r\n处理效应异质性：对于每一个个体i，处理效应βi\\beta_i不同，即处理效应β\\beta是随机变量（\r\n你也可以理解成个体/时间特定的函数），不是一个常数。而在强外生性假设中，我们并未强调这一点。\r\n首先我们需要知道的是，双向固定效应估计量可以折解成22 DID\r\n的加权平均，即Bacon分解（Goodman-Bacon\r\n2021）。数学上证明大家可以看一看Bacon的这篇文章，下面我们来直观地理解一下：\r\nYit=αi+γt+βDit+ϵit Y_{it} = \\alpha _i + \\gamma _t +\\beta D_{it} + \\epsilon _{it} \r\n其中，αi\\alpha_i是个体异质性，γt\\gamma_t是时间异质性，因为i,t随机组合，所以会产生一些”不合适“的22\r\nDID 组合。 - treated v.s. never treated - early treated v.s. later\r\ntreated （处理前） - later treated v.s. earlier\r\ntreated（处理后） 早处理组成为了晚处理组的对照组！！！ &gt;\r\n在异质性处理效应下，传统的双重固定效应（TWFE）估计量可能不再代表“平均处理效应”（ATE）或“处理组的平均处理效应”（ATT），而是某种加权平均，而这个权重有可能是负的。因为早处理组成为了晚处理组的对照组。也就是说，在满足了强外生性条件（或平行趋势）之后处理效应异质性仍然会导致估计量可能无法进行因果解释。\r\n正是因为这些问题，我们将在后面的一个post中介绍更好的异质性处理效应稳健的估计量。\r\n"},{"title":"合成控制法（SCM）及其扩展","url":"/2025/07/17/%E5%90%88%E6%88%90%E6%8E%A7%E5%88%B6%E6%B3%95%E5%8F%8A%E5%85%B6%E6%89%A9%E5%B1%95/","content":"上一章中我们提到了异质性处理效应稳健的估计量，但平行趋势假设仍然不能放松，在这里我们总结一下不要求平行趋势假设的估计量。\r\nQ1：什么是合成控制法？\r\n模型： $$Y_{it} = \\tau D_{it} + \\theta\r\n\\prime _t Z_i +\\xi _t + \\textcolor{red}{\\lambda _i\\prime f_t} +\\epsilon\r\n{it}$$\r\n合成控制法通过引入λi′ft\\lambda _i\\prime f_t交互项来模拟时变混淆变量。（这在DID中是无法解决的。）\r\n假设我们有J+1个观测单位；”1“属于处理组，其他J个单位属于控制组。\r\n（是的，合成控制法只能够对只有1个处理组的情况”下手“！）在时期T0T_0后，”1“对应的部分受到干预。我们的目标是估计”1“这部份对应的干预效果。\r\n平行趋势不一定成立，我们的策略是改变控制组的”趋势“——将控制组个体加权，构造出和处理组趋势一致的样本。\r\n&gt; 处理组：只有一个（或几个），比如加州实行了控烟法。 &gt;\r\n对照组：很多，比如其他未实行政策的州。 &gt;\r\n但直接比较处理组和所有对照组不合理，因为它们”差异”太大！ &gt;\r\n所以我们构造一个加权组合的“合成加州”——使得合成加州在政策前的变量路径最大程度逼近真实加州。\r\nQ2：合成控制法和EB有什么区别？\r\n我们在双重差分法一章中提到了EB（entropy\r\nbalancing熵平衡法），它们似乎都是在对控制组加权构造和处理组相同的特征。其实它们是两种方法，EB是在处理干预前协变量，作为接下来DID的预处理（也就是说它还是DID！）；而合成控制法则是你用其他地区“加权”构造出一个“未被处理但特征很相似的合成处理组”是一个独立的方法。\r\n- 合成控制法构造的是一个单位，比如“合成加州” - EB\r\n是让控制组整体“加权”，并不构造一个单位\r\n同时，二者的加权对象也不一样，SCM加权的目标是匹配结果变量和处理变量，EB加权的目标是匹配协变量。\r\nQ3：合成控制法的进展——合成双重差分法（SDID）\r\n重点：两次加权。对个体加权（类似SCM），对时间加权（类似异质性处理效应稳健的估计量）\r\n 1.\r\n利用处理前数据，通过估计的单元权重ω̂，加权的到合成的控制单元。2.利用控制组数据，通过估计的时期权重\\hat \\omega，加权的到合成的控制单元。\r\n2. 利用控制组数据，通过估计的时期权重$，加权的到合成的处理前时期。\r\n3. 在合成的2x2面板数据上，再在此基础上运用双重差分法。\r\n"},{"title":"异质性处理效应稳健估计量","url":"/2025/07/16/%E5%BC%82%E8%B4%A8%E6%80%A7%E5%A4%84%E7%90%86%E6%95%88%E5%BA%94%E7%A8%B3%E5%81%A5%E4%BC%B0%E8%AE%A1%E9%87%8F/","content":"接下来我们将介绍异质性处理效应稳健的估计量。\r\n首先看一下比较常见的几种实验设计，\r\n静态随机分配（多见于生物学实验，所有单元在统一时间点随机分配到处理组、对照组）\r\n\r\n交错分配Staggered\r\nDID（我们论文中最常见的，不同时间点分阶段进入处理组） \r\n更一般的情况（不同时间点分阶段进入处理组，再在不同时间点分阶段退出处理组，有进入有退出）\r\n\r\n在社会学实验中，我们见到的是第二种和第三种实验设计类型，针对不同的实验设计我们有不同的异质性处理效应稳健的估计量。\r\nQ1：异质性处理效应稳健的估计量有哪些，都针对什么情形？\r\nIW估计量（Sun\r\n&amp; Abraham(2021)）—— 针对交错分配的实验设计\r\n交互加权（interaction Weighted, IW）\r\n对照组：一直未接受处理的个体。若没有非处理组，则把最右边那列拿掉，构造出”非处理组“\r\n\r\nCSDID估计量（Callaway\r\n&amp; Aant’Anna(2021)）—— 针对交错分配的实验设计\r\n对照组：一直未接受处理的个体和还未接受处理的个体。相较于IW估计量而言，CSDID估计量拥有更大的样本量（如图，对照组数量从2个变到了4个）。但不好的点是，对照组是变化的，不太好处理（不过不用担心！stata内置算法已经帮我们处理好了一切！）。\r\n\r\nDIDMDID_M\r\n估计量（de Chaisemartion &amp; D’Haultfoeuille(2020)）——\r\n针对更一般的实验设计\r\n当我们在调查历史事件时，会发现有的政策可能在某个州实行了，不久后又被取消了，这种时候就需要更一般的异质性处理效应稳健的估计量了。\r\n&gt; 比如堕胎法案在美国的各个州就多次被取消。 \r\n对照组：该时期间（在图中就是粉色的竖列）未接受处理的个体。所有黑色勾的个体构成了对照组。\r\n&gt; 一个基本思想：构造经典DID。\r\nPanelMatch\r\n估计量（Imai, Kim &amp; Wang(2021)）—— 针对更一般的实验设计\r\n在DIDMDID_M估计量的基础上，横向拓展（增加了一期数据），纵向做匹配。\r\n&gt;\r\n一个比较直观的理解是，DIDMDID_M是纵向拓展样本量，PanelMatch是在纵向拓展的基础上再横向拓展样本量。\r\n\r\n对照组：横向多拉入一期数据，纵向做匹配。\r\n插补法：DIDinputeDID_{inpute}\r\n估计量（BJS(2021);LWX(2022)）\r\n插补法：不考虑时间维度，先拿掉处理期的处理组，用非处理期的处理组去估计处理期的缺失值/hatYit(0)/hat Y _{it}(0)，也就是固定效应反事实估计量估计（fect）。处理效应即为β̂it=Yit−Ŷit(0)\\hat \\beta_{it} = Y_{it} - \\hat Y_{it}(0)。再基于β̂it\\hat \\beta_{it}加总。这里的反事实估计量是不是很好理解？因为在t=2的处理组上面并没有发生有不被处理个体的情况！就像薛定谔的猫，当我们打开盒子之后，猫的死活只会有一种状态。那么在我们观测时，每一个个体的处理与否也只会有一个状态。\r\n\r\n基本思想：利用已有的数据，对缺失数据进行估计。\r\n这里的基本思想和前几种估计量的就不太一样了，前几种估计量都是在凑经典DID，而插补法是用非处理期的处理组去估计处理期的缺失值。\r\n\r\nQ2：要满足什么假设？\r\n虽然说我们介绍的上述估计量放松了”同质性处理效应“的假设，但仍对动态有很强的假设（即平行趋势假设依然重要）！\r\nQ3：如何应用异质性处理效应稳健的模型？\r\n第一步：通过画出原始数据的图，了解背景、设定、数据结构；记录关键信息\r\n*选取部分观测值利用panelview绘制图示以直观了解数据panelview Y DA, i(id) t(cycle) type(treat)\r\n第二步：对使用原始方差估计量和据类自助抽样的偏好函数形式的主要结果进行复制\r\n第三步：使用双固定定效应和多种异质性处理效应稳健估计量对平均处理效应（ATT）和动态效应进行估计\r\n********************* TWFE ************************基准TWFE回归：估计的是“有没有效应”reghdfe Y DA DB DH, absorb(id cycle) cluster(id)* 生成各期处理组的虚拟变量* 生成每个个体首次受到处理的时间（用于确定事件时点）bys id: egen treatcycle_m = min(cycle) if DA==1tab treatcycle_m,m* 为所有观察赋予该个体的处理时间（广播处理时间）bys id: egen treatcycle = mean (treatcycle_m)tab treatcycle,m*生成相对时间变量 tintra：这里 cycle 是当前时期，treatcycle 是个体接受处理的时期，tintra 表示个体 i 在周期 t 相对其第一次接受处理的期数。gen _tintra=(cycle-treatcycle)/2tab _tintra,mglobal t 11tab _tintra,m* 构造事前期（t&lt;0）的虚拟变量 F_-1, F_-2, ..., F_-11（循环生成）forvalues l = 1/$t &#123;    gen F_`l&#x27; = _tintra==-`l&#x27;&#125;* 继续构造更早期（比如-11到-16）的事件期变量sum _tintraforvalues l = 11/16 &#123;    gen F`l&#x27;event = _tintra==-`l&#x27;&#125;* 构造事后期（t&gt;=0）的虚拟变量 L0event, L1event, ..., L16eventforvalues l = 0/16 &#123;    gen L`l&#x27;event =  _tintra==`l&#x27;&#125;* 重命名事件当期为 L_0（方便后续识别）ren (L0event) (L_0)*将-1期设定为基期，值设为0replace F_1 = 0*再次TWFE回归：估计的是“在什么时候产生的效应，有多大”reghdfe Y L* F* DB DH, absorb(id cycle) cluster(id) *绘制图象（事件研究）/*本文数据事后的observation数量很少，noise很大，故不在图中显示*/\tevent_plot e(b)#e(V), plottype(scatter) ///\tstub_lag(L_#) stub_lead(F_#) together ///\tgraph_opt(name($article_TWFE, replace) ///\ttitle(&quot;$article-TWFE&quot;) ///\txtitle(&quot;Periods since the event&quot;) ///\tytitle(&quot;Average causal effect&quot;)   ///\txlabel(-11(1)0) ylabel(-0.15(0.05)0.2) ///\tyline(0, lp(dash) lc(gs0) lw(thin)) ///\txline(-1, lp(dash) lc(gs0) lw(thin)) ) \t\t/*！graph常用功能与命令：*如需调用图象：graph dis $article_TWFE*另存为stata可编辑图象：graph save &quot;命名.gph&quot;, replace*导出图象为png图片：graph export &quot;命名.png&quot;, replace*/\r\n第四步：基于fect来检验（可视化检验、检验事前趋势、检验延迟效应）\r\n****************FEct ***************************/*基于 fect 命令，研究者可以生成 3 个关于 ATT 的反事实因果估计指标：(1) 固定效应的反事实因果估计量  (Fixed-effect counterfactual estimator) ;(2) 交互固定效应的反事实估计量 (Interactive fixed-effect counterfactual estimator) ;(3) 矩阵完备估计量 (Matrix completion estimator)。此处代码主要采用固定效应的反事实因果估计量 (FEct) 进行演示。*/*----------运行命令----------*fect Y, treat(DA) unit(id) time(cycle) cov(DB DH) method(fe) ///\tforce(two-way) preperiod(-11) offperiod(1) minT0(1)/*此处同样可以使用graph一系列命令进行图片的调用、保存与导出，略去不表。*/*绘制置信区间（bootstrap 标准误）fect Y, treat(DA) unit(id) time(cycle) cov(DB DH) method(fe) ///\tforce(two-way) preperiod(-11) offperiod(1) se nboots(100) minT0(1)*倘若需要知道 ATT 的精确数值，输入如下命令:mat list e(ATT)*倘若需要获取协变量和常数项的具体估计结果，输入如下命令:mat list e(coefs)*----------事前趋势检验（Pretrends Test）----------*/*采用Wald Test来测度处理前的趋势。原假设：在不同时期内样本处理前的残差均值都等于零。*/fect Y, treat(DA) unit(id) time(cycle) cov(DB DH) method(fe) ///\tforce(two-way) preperiod(-11) offperiod(1) minT0(1) ///\tse nboots(200) wald /* p 值大于 0.05，无法拒绝原假设；即样本在处理前的趋势是相似的。*/*----------安慰剂检验（Placebo Test）----------*/*选定处理前的某一时间段作为&quot;安慰剂期&quot;，删除该时段后对模型进行拟合，然后检验该时段内的 ATT 是否显著不为零。通常使用处理前 -2、-1和 0期作为安慰剂周期；也可以使用 palceboperiod() 自定义安慰剂期。*/fect Y, treat(DA) unit(id) time(cycle) cov(DB DH) method(fe) ///\tforce(two-way) preperiod(-11) offperiod(1) minT0(1) ///\tse nboots(100) placeboTest/*结果：左上角为安慰剂检验的 p 值。 p 值为 0.571 ，不能拒绝安慰剂周期内的 ATT 等于 0 的原假设。图中也显示，安慰剂区域 (Placebo Region) 与零值存在交集，通过安慰剂检验。*/\r\nQ4：面临的问题\r\n\r\n数据缺失问题\r\n明显的事前趋势（平行趋势假设不满足）\r\n延续效应 接下来我们将讲述在平行趋势假设不满足时进行估计。\r\n\r\n"}]